# Configuração Nginx para Anti-Scraping
# =====================================
# Se você usa Nginx, coloque isso em seu bloco server

server {
    listen 80;
    listen 443 ssl http2;
    server_name seusite.com www.seusite.com;

    # ========================================
    # Bloquear User-Agents Maliciosos
    # ========================================
    if ($http_user_agent ~* (HTTrack|wget|curl|WebCopier|Teleport|Offline|Scrapy|python-requests|urllib|libwww|java.*HttpClient)) {
        return 403;
    }

    # Bloquear requisições sem User-Agent
    if ($http_user_agent = "") {
        return 403;
    }

    # ========================================
    # Headers de Segurança
    # ========================================
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # ========================================
    # Rate Limiting
    # ========================================
    limit_req_zone $binary_remote_addr zone=scraper_limit:10m rate=10r/s;
    limit_req zone=scraper_limit burst=20 nodelay;

    # ========================================
    # Desabilitar Métodos Perigosos
    # ========================================
    if ($request_method !~ ^(GET|HEAD|POST|OPTIONS)$) {
        return 405;
    }

    # ========================================
    # Proteger Arquivos Sensíveis
    # ========================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ (\.ht|\.git|\.gitignore|\.env) {
        deny all;
    }

    # ========================================
    # Desabilitar Listagem de Diretórios
    # ========================================
    autoindex off;

    # ========================================
    # Implementação de CORS Restrito
    # ========================================
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '$http_origin';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
    }

    # ========================================
    # Cache Busting para Imagens
    # ========================================
    location ~* \.(jpg|jpeg|gif|png|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # ========================================
    # Bloquear Hotlinking
    # ========================================
    location ~ \.(jpg|jpeg|gif|png|pdf)$ {
        valid_referers none blocked ~^https?://(www\.)?seusite.com;
        if ($invalid_referer) {
            return 403;
        }
    }

    # ========================================
    # Proxy Reverso Protection
    # ========================================
    if ($http_x_forwarded_for != "") {
        # Aceitar apenas de IPs confiáveis
        set $client_ip $http_x_forwarded_for;
    }

    # Sua localização raiz
    root /var/www/seusite/html;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }

    # ========================================
    # Gzip Compression
    # ========================================
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;
}
